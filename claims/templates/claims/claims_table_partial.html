{% load static %}
{% load claims_extras %}

<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <div class="flex justify-between items-center mb-6">
            <h2 class="card-title text-2xl">
                <i class="fas fa-table text-primary mr-2"></i>
                Claims Overview
                <div class="badge badge-primary badge-lg">{{ claims.count }} Claims</div>
            </h2>
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-outline btn-sm">
                    <i class="fas fa-download mr-2"></i>Export
                    <i class="fas fa-chevron-down ml-1"></i>
                </div>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a><i class="fas fa-file-excel mr-2"></i>Export to Excel</a></li>
                    <li><a><i class="fas fa-file-csv mr-2"></i>Export to CSV</a></li>
                    <li><a><i class="fas fa-file-pdf mr-2"></i>Export to PDF</a></li>
                </ul>
            </div>
        </div>

        {% if claims %}
        <div class="overflow-x-auto">
            <table class="table table-zebra w-full" 
                   role="table" 
                   aria-label="Claims data table"
                   aria-describedby="table-description">
                <caption id="table-description" class="sr-only">
                    Table showing {{ total_claims }} claims with columns for claim ID, patient information, insurer, amount, status, date, and actions. 
                    Use arrow keys to navigate and Enter to interact with elements.
                </caption>
                <thead>
                    <tr class="bg-base-200" role="row">
                        <th class="font-bold" scope="col">
                            <div class="flex items-center">
                                <i class="fas fa-hashtag mr-2" aria-hidden="true"></i>
                                <button class="text-left font-bold hover:underline focus:underline" 
                                        onclick="window.ClaimsTable.sortTable('id')"
                                        aria-label="Sort by claim ID">
                                    Claim ID
                                    <i class="fas fa-sort ml-1 text-xs" aria-hidden="true"></i>
                                </button>
                            </div>
                        </th>
                        <th class="font-bold" scope="col">
                            <div class="flex items-center">
                                <i class="fas fa-user mr-2" aria-hidden="true"></i>
                                <button class="text-left font-bold hover:underline focus:underline" 
                                        onclick="window.ClaimsTable.sortTable('patient')"
                                        aria-label="Sort by patient name">
                                    Patient
                                    <i class="fas fa-sort ml-1 text-xs" aria-hidden="true"></i>
                                </button>
                            </div>
                        </th>
                        <th class="font-bold" scope="col">
                            <div class="flex items-center">
                                <i class="fas fa-building mr-2" aria-hidden="true"></i>
                                <button class="text-left font-bold hover:underline focus:underline" 
                                        onclick="window.ClaimsTable.sortTable('insurer')"
                                        aria-label="Sort by insurer">
                                    Insurer
                                    <i class="fas fa-sort ml-1 text-xs" aria-hidden="true"></i>
                                </button>
                            </div>
                        </th>
                        <th class="font-bold" scope="col">
                            <div class="flex items-center">
                                <i class="fas fa-dollar-sign mr-2" aria-hidden="true"></i>
                                <button class="text-left font-bold hover:underline focus:underline" 
                                        onclick="window.ClaimsTable.sortTable('amount')"
                                        aria-label="Sort by claim amount">
                                    Amount
                                    <i class="fas fa-sort ml-1 text-xs" aria-hidden="true"></i>
                                </button>
                            </div>
                        </th>
                        <th class="font-bold" scope="col">
                            <div class="flex items-center">
                                <i class="fas fa-flag mr-2" aria-hidden="true"></i>
                                <button class="text-left font-bold hover:underline focus:underline" 
                                        onclick="window.ClaimsTable.sortTable('status')"
                                        aria-label="Sort by status">
                                    Status
                                    <i class="fas fa-sort ml-1 text-xs" aria-hidden="true"></i>
                                </button>
                            </div>
                        </th>
                        <th class="font-bold" scope="col">
                            <div class="flex items-center">
                                <i class="fas fa-calendar mr-2" aria-hidden="true"></i>
                                <button class="text-left font-bold hover:underline focus:underline" 
                                        onclick="window.ClaimsTable.sortTable('date')"
                                        aria-label="Sort by claim date">
                                    Date
                                    <i class="fas fa-sort ml-1 text-xs" aria-hidden="true"></i>
                                </button>
                            </div>
                        </th>
                        <th class="font-bold" scope="col">
                            <div class="flex items-center">
                                <i class="fas fa-tools mr-2" aria-hidden="true"></i>
                                Actions
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for claim in claims %}
                    <tr class="hover:bg-base-200 transition-colors focus-within:bg-base-300" 
                        role="row"
                        tabindex="0"
                        onkeydown="window.ClaimsTable.handleTableRowKeydown(event, {{ claim.id }})"
                        aria-describedby="claim-{{ claim.id }}-description">
                        <td role="gridcell">
                            <div class="font-mono text-sm">
                                <span class="badge badge-outline" id="claim-{{ claim.id }}-id">{{ claim.id }}</span>
                            </div>
                        </td>
                        <td role="gridcell">
                            <div class="flex items-center space-x-3">
                                <div class="avatar placeholder">
                                    <div class="bg-neutral-focus text-neutral-content rounded-full w-8 h-8">
                                        <span class="text-xs">{{ claim.patient_name|first }}</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="font-bold">{{ claim.patient_name }}</div>
                                    <div class="text-sm opacity-50">ID: {{ claim.patient_id }}</div>
                                </div>
                            </div>
                        </td>
                        <td role="gridcell">
                            <div class="flex items-center">
                                <i class="fas fa-shield-alt text-primary mr-2" aria-hidden="true"></i>
                                <span class="font-medium">{{ claim.insurer_name }}</span>
                            </div>
                        </td>
                        <td role="gridcell">
                            <div class="text-right">
                                <span class="font-bold text-lg" 
                                      aria-label="Claim amount {{ claim.billed_amount|floatformat:2 }} dollars">
                                    ${{ claim.billed_amount|floatformat:2 }}
                                </span>
                            </div>
                        </td>
                        <td role="gridcell">
                            {% if claim.status == 'Paid' %}
                                <div class="badge badge-success gap-2" 
                                     role="status"
                                     aria-label="Claim status: Paid">
                                    <i class="fas fa-check-circle" aria-hidden="true"></i>
                                    {{ claim.status }}
                                </div>
                            {% elif claim.status == 'Denied' %}
                                <div class="badge badge-error gap-2" 
                                     role="status"
                                     aria-label="Claim status: Denied">
                                    <i class="fas fa-times-circle" aria-hidden="true"></i>
                                    {{ claim.status }}
                                </div>
                            {% elif claim.status == 'Under Review' %}
                                <div class="badge badge-warning gap-2" 
                                     role="status"
                                     aria-label="Claim status: Under Review">
                                    <i class="fas fa-clock" aria-hidden="true"></i>
                                    {{ claim.status }}
                                </div>
                            {% else %}
                                <div class="badge badge-info gap-2" 
                                     role="status"
                                     aria-label="Claim status: {{ claim.status }}">
                                    <i class="fas fa-info-circle" aria-hidden="true"></i>
                                    {{ claim.status }}
                                </div>
                            {% endif %}
                        </td>
                        <td role="gridcell">
                            <div class="text-sm">
                                <div class="font-medium" 
                                     aria-label="Claim date {{ claim.discharge_date|date:'F j, Y' }}">
                                    {{ claim.discharge_date|date:"M d, Y" }}
                                </div>
                                <div class="opacity-50" 
                                     aria-label="{{ claim.discharge_date|timesince }} ago">
                                    {{ claim.discharge_date|timesince }} ago
                                </div>
                            </div>
                        </td>
                        <td role="gridcell">
                            <div class="flex space-x-2" role="group" aria-label="Claim actions">
                                <!-- View Button -->
                                <button class="btn btn-sm btn-primary btn-outline"
                                        hx-get="{% url 'claim_detail' claim.id %}"
                                        hx-target="#claim-detail-modal .modal-box"
                                        hx-trigger="click"
                                        onclick="document.getElementById('claim-detail-modal').showModal()"
                                        aria-label="View details for claim {{ claim.id }}">
                                    <i class="fas fa-eye" aria-hidden="true"></i>
                                    <span class="sr-only">View</span>
                                </button>
                                
                                <!-- Flag Button (if authenticated) -->
                                {% if user.is_authenticated %}
                                <div class="dropdown dropdown-end">
                                    <div tabindex="0" 
                                         role="button" 
                                         class="btn btn-sm btn-warning btn-outline"
                                         aria-label="Flag claim {{ claim.id }} for review"
                                         aria-haspopup="true"
                                         aria-expanded="false">
                                        <i class="fas fa-flag" aria-hidden="true"></i>
                                        <span class="sr-only">Flag</span>
                                    </div>
                                    <ul tabindex="0" 
                                        class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52"
                                        role="menu">
                                        <li role="none">
                                            <a role="menuitem"
                                               hx-post="{% url 'flag_claim' claim.id %}" 
                                               hx-vals='{"reason": "Review Required"}'
                                               hx-confirm="Flag this claim for review?">
                                                <i class="fas fa-exclamation-triangle mr-2" aria-hidden="true"></i>
                                                Review Required
                                            </a>
                                        </li>
                                        <li role="none">
                                            <a role="menuitem"
                                               hx-post="{% url 'flag_claim' claim.id %}" 
                                               hx-vals='{"reason": "Documentation Issue"}'
                                               hx-confirm="Flag this claim for documentation issues?">
                                                <i class="fas fa-file-alt mr-2" aria-hidden="true"></i>
                                                Documentation Issue
                                            </a>
                                        </li>
                                        <li role="none">
                                            <a role="menuitem"
                                               hx-post="{% url 'flag_claim' claim.id %}" 
                                               hx-vals='{"reason": "Billing Error"}'
                                               hx-confirm="Flag this claim for billing errors?">
                                                <i class="fas fa-dollar-sign mr-2" aria-hidden="true"></i>
                                                Billing Error
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                {% endif %}
                                
                                <!-- More Actions -->
                                <div class="dropdown dropdown-end">
                                    <div tabindex="0" 
                                         role="button" 
                                         class="btn btn-sm btn-ghost"
                                         aria-label="More actions for claim {{ claim.id }}"
                                         aria-haspopup="true"
                                         aria-expanded="false">
                                        <i class="fas fa-ellipsis-v" aria-hidden="true"></i>
                                        <span class="sr-only">More</span>
                                    </div>
                                    <ul tabindex="0" 
                                        class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52"
                                        role="menu">
                                        <li role="none">
                                            <a role="menuitem" 
                                               href="{% url 'claim_detail' claim.id %}"
                                               target="_blank">
                                                <i class="fas fa-external-link-alt mr-2" aria-hidden="true"></i>
                                                Open in New Tab
                                            </a>
                                        </li>
                                        <li role="none">
                                            <a role="menuitem" onclick="window.ClaimsTable.printClaim({{ claim.id }})">>
                                                <i class="fas fa-print mr-2" aria-hidden="true"></i>
                                                Print Claim
                                            </a>
                                        </li>
                                        <li role="none">
                                            <a role="menuitem" onclick="window.ClaimsTable.shareClaim({{ claim.id }})">>
                                                <i class="fas fa-share mr-2" aria-hidden="true"></i>
                                                Share
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                        
                        <!-- Hidden description for screen readers -->
                        <div id="claim-{{ claim.id }}-description" class="sr-only">
                            Claim {{ claim.id }} for patient {{ claim.patient_name }}, 
                            insured by {{ claim.insurer_name }}, 
                            amount ${{ claim.billed_amount|floatformat:2 }}, 
                            status {{ claim.status }}, 
                            submitted {{ claim.discharge_date|date:"F j, Y" }}
                        </div>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if claims.has_other_pages %}
        <div class="flex flex-col sm:flex-row justify-between items-center mt-8 gap-4">
            <!-- Pagination Info -->
            <div class="text-sm text-base-content/70">
                <span class="sr-only">Pagination information</span>
                Showing 
                <span class="font-medium">{{ claims.start_index }}</span>
                to 
                <span class="font-medium">{{ claims.end_index }}</span>
                of 
                <span class="font-medium">{{ total_claims }}</span>
                results
            </div>
            
            <!-- Items Per Page Selector -->
            <div class="flex items-center gap-2">
                <label for="per-page-select" class="text-sm">Show:</label>
                <select id="per-page-select" 
                        class="select select-bordered select-sm w-20"
                        onchange="window.ClaimsTable.changeItemsPerPage(this.value)"
                        aria-label="Items per page">
                    {% for option in "10,25,50,100"|split:"," %}
                        <option value="{{ option }}" {% if items_per_page == option|add:0 %}selected{% endif %}>
                            {{ option }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Advanced Pagination Controls -->
            <nav aria-label="Pagination Navigation" class="flex items-center">
                <div class="join">
                    <!-- First Page -->
                    {% if claims.has_previous %}
                        <button onclick="window.ClaimsTable.goToPage(1)" 
                                class="join-item btn btn-sm" 
                                title="Go to first page"
                                aria-label="Go to first page">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button onclick="window.ClaimsTable.goToPage({{ claims.previous_page_number }})" 
                                class="join-item btn btn-sm" 
                                title="Go to previous page"
                                aria-label="Go to previous page">
                            <i class="fas fa-angle-left"></i>
                        </button>
                    {% else %}
                        <span class="join-item btn btn-sm btn-disabled" aria-hidden="true">
                            <i class="fas fa-angle-double-left"></i>
                        </span>
                        <span class="join-item btn btn-sm btn-disabled" aria-hidden="true">
                            <i class="fas fa-angle-left"></i>
                        </span>
                    {% endif %}
                    
                    <!-- Page Numbers with Smart Range -->
                    {% for page_num in page_range %}
                        {% if page_num == '...' %}
                            <span class="join-item btn btn-sm btn-disabled" aria-hidden="true">…</span>
                        {% elif page_num == claims.number %}
                            <span class="join-item btn btn-sm btn-active" 
                                  aria-current="page"
                                  aria-label="Current page, page {{ page_num }}">
                                {{ page_num }}
                            </span>
                        {% else %}
                            <button onclick="window.ClaimsTable.goToPage({{ page_num }})" 
                                    class="join-item btn btn-sm"
                                    aria-label="Go to page {{ page_num }}">
                                {{ page_num }}
                            </button>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Last Page -->
                    {% if claims.has_next %}
                        <button onclick="window.ClaimsTable.goToPage({{ claims.next_page_number }})" 
                                class="join-item btn btn-sm"
                                title="Go to next page"
                                aria-label="Go to next page">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button onclick="window.ClaimsTable.goToPage({{ claims.paginator.num_pages }})" 
                                class="join-item btn btn-sm"
                                title="Go to last page"
                                aria-label="Go to last page">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    {% else %}
                        <span class="join-item btn btn-sm btn-disabled" aria-hidden="true">
                            <i class="fas fa-angle-right"></i>
                        </span>
                        <span class="join-item btn btn-sm btn-disabled" aria-hidden="true">
                            <i class="fas fa-angle-double-right"></i>
                        </span>
                    {% endif %}
                </div>
            </nav>
        </div>
        
        <!-- Quick Page Jump -->
        <div class="mt-4 text-center">
            <div class="inline-flex items-center gap-2">
                <label for="page-jump" class="text-sm">Jump to page:</label>
                <input type="number" 
                       id="page-jump"
                       min="1" 
                       max="{{ claims.paginator.num_pages }}" 
                       value="{{ claims.number }}"
                       class="input input-bordered input-sm w-20 text-center"
                       onkeypress="window.ClaimsTable.handlePageJump(event)"
                       aria-label="Jump to specific page">
                <button onclick="window.ClaimsTable.jumpToPage()" 
                        class="btn btn-sm btn-primary"
                        aria-label="Go to specified page">
                    Go
                </button>
            </div>
        </div>
        {% endif %}

        {% else %}
        <!-- Empty State -->
        <div class="text-center py-12" role="status" aria-live="polite">
            <div class="w-24 h-24 mx-auto mb-4 bg-base-200 rounded-full flex items-center justify-center" aria-hidden="true">
                <i class="fas fa-search text-4xl text-base-content opacity-50"></i>
            </div>
            <h3 class="text-xl font-bold mb-2">No Claims Found</h3>
            <p class="text-base-content opacity-70 mb-4">
                {% if search_query or status_filter or insurer_filter %}
                    No claims match your current filters. Try adjusting your search criteria.
                {% else %}
                    No claims are currently available in the system.
                {% endif %}
            </p>
            <div class="flex justify-center gap-2">
                {% if search_query or status_filter or insurer_filter %}
                    <a href="{% url 'claims_list' %}" class="btn btn-primary">
                        <i class="fas fa-refresh mr-2"></i>Reset Filters
                    </a>
                {% endif %}
                <button class="btn btn-outline" onclick="window.location.reload()">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Claim Detail Modal -->
<dialog id="claim-detail-modal" class="modal">
    <div class="modal-box w-11/12 max-w-5xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" aria-label="Close modal">✕</button>
        </form>
        <!-- Content will be loaded here by HTMX -->
        <div class="loading loading-spinner loading-lg mx-auto block"></div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button aria-label="Close modal">close</button>
    </form>
</dialog>

